"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[761],{1674:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>a,contentTitle:()=>o,default:()=>h,frontMatter:()=>s,metadata:()=>d,toc:()=>c});var t=i(4848),r=i(8453);const s={sidebar_position:8},o="Demo",d={id:"demo",title:"Demo",description:"Run a full diracx demo",source:"@site/docs/demo.md",sourceDirName:".",slug:"/demo",permalink:"/diracx/docs/demo",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/demo.md",tags:[],version:"current",sidebarPosition:8,frontMatter:{sidebar_position:8},sidebar:"tutorialSidebar",previous:{title:"OpenTelemetry",permalink:"/diracx/docs/opentelemetry"},next:{title:"Migration",permalink:"/diracx/docs/migration"}},a={},c=[{value:"Run a full diracx demo",id:"run-a-full-diracx-demo",level:2},{value:"Create the dev environment",id:"create-the-dev-environment",level:2},{value:"Run the test",id:"run-the-test",level:3},{value:"Run a local instance of diracx",id:"run-a-local-instance-of-diracx",level:3},{value:"Add a DB",id:"add-a-db",level:2},{value:"Dependency injection",id:"dependency-injection",level:2},{value:"Configuration",id:"configuration",level:3},{value:"Settings",id:"settings",level:3},{value:"Databases",id:"databases",level:3},{value:"User information",id:"user-information",level:3},{value:"Adding a router",id:"adding-a-router",level:2},{value:"Creating the router submodule",id:"creating-the-router-submodule",level:3},{value:"Defining the new router in the <code>diracx.services</code> entrypoint",id:"defining-the-new-router-in-the-diracxservices-entrypoint",level:3},{value:"Conventions",id:"conventions",level:2},{value:"Coding style",id:"coding-style",level:3},{value:"Import style",id:"import-style",level:4}];function l(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"demo",children:"Demo"}),"\n",(0,t.jsx)(n.h2,{id:"run-a-full-diracx-demo",children:"Run a full diracx demo"}),"\n",(0,t.jsx)(n.p,{children:"This will allow you to run a demo setup."}),"\n",(0,t.jsx)(n.p,{children:"The code changes will be reflected in the demo."}),"\n",(0,t.jsx)(n.p,{children:"Requirement: docker, internet"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Clone the diracx repository\ngit clone git@github.com:DIRACGrid/diracx.git\n\n# Clone the diracx-chart repository\ngit clone git@github.com:DIRACGrid/diracx-charts.git\n\n# Run the demo\ndiracx-charts/run_demo.sh diracx/\n"})}),"\n",(0,t.jsxs)(n.p,{children:["To login, click the ",(0,t.jsx)(n.strong,{children:"authorize"})," button"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"authorize",src:i(2001).A+"",width:"180",height:"52"})}),"\n",(0,t.jsxs)(n.p,{children:['Connect using the authorization code flow, ticking the "vo',":diracAdmin",'" scope']}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"codeflow",src:i(7770).A+"",width:"547",height:"503"})}),"\n",(0,t.jsxs)(n.p,{children:["And enter the credentials prompted by the ",(0,t.jsx)(n.code,{children:"run_demo.sh"})," script in the ",(0,t.jsx)(n.code,{children:"Dex"})," interface"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"Dexlogin",src:i(6627).A+"",width:"553",height:"333"})}),"\n",(0,t.jsx)(n.h2,{id:"create-the-dev-environment",children:"Create the dev environment"}),"\n",(0,t.jsx)(n.p,{children:"This will help you setup a dev environment to run the unit tests"}),"\n",(0,t.jsx)(n.p,{children:"Requirements: conda, git"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Clone the diracx repository\ngit clone git@github.com:DIRACGrid/diracx.git\ncd diracx\n\n# Create the mamba environment\nmamba env create --file environment.yml\nconda activate diracx-dev\n\n# Make an editable installation of diracx\n\npip install -r requirements-dev.txt\n\n# Install the patched DIRAC version\npip install git+https://github.com/DIRACGrid/DIRAC.git@integration\n\n# Enable pre-commit\nmamba install pre-commit\npre-commit install\n"})}),"\n",(0,t.jsx)(n.h3,{id:"run-the-test",children:"Run the test"}),"\n",(0,t.jsx)(n.p,{children:"Run the unit tests:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# In the `diracx` folder\npytest\nmypy\npre-commit run --all-files\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Some tests require the DiracX demo instance to be running (see above) and are skipped by default.\nTo enable these tests pass ",(0,t.jsx)(n.code,{children:"--demo-dir"})," like so:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"pytest --demo-dir=../diracx-charts/\n"})}),"\n",(0,t.jsx)(n.h3,{id:"run-a-local-instance-of-diracx",children:"Run a local instance of diracx"}),"\n",(0,t.jsx)(n.p,{children:"This only runs the diracx server, not any dependency like external IdP."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# In the `diracx` folder\n./run_local.sh\n"})}),"\n",(0,t.jsx)(n.h2,{id:"add-a-db",children:"Add a DB"}),"\n",(0,t.jsxs)(n.p,{children:["Database classes live in ",(0,t.jsx)(n.code,{children:"src/diracx/db/<dbname>"}),". Have a look at the ",(0,t.jsx)(n.code,{children:"src/diracx/db/dummy/"})," to see how to implement your own DB"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["We do not want to use the ",(0,t.jsx)(n.code,{children:"ORM"})," part of ",(0,t.jsx)(n.code,{children:"SQLAlchemy"})," (only the ",(0,t.jsx)(n.code,{children:"core"}),") for performance reasons"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"dependency-injection",children:"Dependency injection"}),"\n",(0,t.jsx)(n.p,{children:"Dependencies to routes on services are injected as function parameters.\nSee the FastAPI documentation for details."}),"\n",(0,t.jsx)(n.p,{children:"In DiracX we have a few additional dependencies which can be injected like so:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'@router.get("/dummy")\ndef my_route(\n    config: Annotated[Config, Depends(ConfigSource.create)],\n    settings: Annotated[AuthSettings, Depends(AuthSettings.create)],\n    job_db: Annotated[JobDB, Depends(JobDB.transaction)],\n    user_info: Annotated[UserInfo, Depends(verify_dirac_token)],\n) -> MyReturnType:\n    ...\n'})}),"\n",(0,t.jsx)(n.h3,{id:"configuration",children:"Configuration"}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"config"})," object is an instance of the config model schema for the current service (e.g. ",(0,t.jsx)(n.code,{children:"diracx.core.config.Config"}),").\nThis object is immutable and remains constant for the duration of the function call.\nCaching is handled externally to services."]}),"\n",(0,t.jsx)(n.h3,{id:"settings",children:"Settings"}),"\n",(0,t.jsxs)(n.p,{children:['Unlike in DIRAC, DiracX separates some information from the "Configuration" (e.g. secrets).\nTo access this information you depend on the ',(0,t.jsx)(n.code,{children:"SettingsClass.create"})," method which returns a cached instance of the given class."]}),"\n",(0,t.jsx)(n.h3,{id:"databases",children:"Databases"}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"job_db"})," object is an instance of the given db (e.g. ",(0,t.jsx)(n.code,{children:"JobDB"}),").\nA single transaction is used for the duration of the request and it is automatically committed when the function returns.\nIf an exception is raised the transaction is rolled back.\nConnections are pooled between requests."]}),"\n",(0,t.jsx)(n.h3,{id:"user-information",children:"User information"}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"user_info"})," object contains validation information about the current user, extracted from the authorization header of the request.\nSee the ",(0,t.jsx)(n.code,{children:"UserInfo"})," class for the available properties."]}),"\n",(0,t.jsx)(n.h2,{id:"adding-a-router",children:"Adding a router"}),"\n",(0,t.jsx)(n.p,{children:"To add a router there are two steps:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["Create a module in ",(0,t.jsx)(n.code,{children:"diracx.routers"})," for the given service."]}),"\n",(0,t.jsxs)(n.li,{children:["Add an entry to the ",(0,t.jsx)(n.code,{children:"diracx.services"})," entrypoint."]}),"\n",(0,t.jsx)(n.li,{children:"Do not forget the Access Policy (see chapter lower down)"}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["We'll now make a ",(0,t.jsx)(n.code,{children:"/parking/"})," router which contains information store in the ",(0,t.jsx)(n.code,{children:"DummyDB"}),"."]}),"\n",(0,t.jsx)(n.h3,{id:"creating-the-router-submodule",children:"Creating the router submodule"}),"\n",(0,t.jsxs)(n.p,{children:["TODO: This isn't yet documented here however see ",(0,t.jsx)(n.code,{children:"diracx.routers.auth.well_known"})," for an example."]}),"\n",(0,t.jsxs)(n.h3,{id:"defining-the-new-router-in-the-diracxservices-entrypoint",children:["Defining the new router in the ",(0,t.jsx)(n.code,{children:"diracx.services"})," entrypoint"]}),"\n",(0,t.jsxs)(n.p,{children:["Modify the package's ",(0,t.jsx)(n.code,{children:"setup.cfg"})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ini",children:"[options.entry_points]\ndiracx.services =\n\tparking = diracx.routers.parking:router\n"})}),"\n",(0,t.jsxs)(n.p,{children:["This will prefix the routes with ",(0,t.jsx)(n.code,{children:"/parking/"})," and mark them with the ",(0,t.jsx)(n.code,{children:'"parking"'})," tag in the OpenAPI spec."]}),"\n",(0,t.jsx)(n.admonition,{type:"warning",children:(0,t.jsxs)(n.p,{children:["Any modification in the ",(0,t.jsx)(n.code,{children:"setup.cfg"})," requires to re-install install ",(0,t.jsx)(n.code,{children:"diracx"}),", even if it is a developer installation (",(0,t.jsx)(n.code,{children:"pip install -e"}),")"]})}),"\n",(0,t.jsx)(n.h2,{id:"conventions",children:"Conventions"}),"\n",(0,t.jsx)(n.h3,{id:"coding-style",children:"Coding style"}),"\n",(0,t.jsxs)(n.p,{children:["Most style are enforced with the pre-commit hooks which automatically reformat the code and sort the imports.\nCode should follow PEP-8, particularly for ",(0,t.jsx)(n.a,{href:"https://peps.python.org/pep-0008/#prescriptive-naming-conventions",children:"naming conventions"})," as these aren't modified by the pre-commit hooks."]}),"\n",(0,t.jsx)(n.h4,{id:"import-style",children:"Import style"}),"\n",(0,t.jsx)(n.p,{children:"In addition to the automatic sorting"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"from datetime import datetime, timedelta, timezone\n\nimport pytest\n"})})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}},2001:(e,n,i)=>{i.d(n,{A:()=>t});const t="data:image/png;base64,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"},7770:(e,n,i)=>{i.d(n,{A:()=>t});const t=i.p+"assets/images/login_demo_2-3c7f912da6197c0be0d4ff92c225459a.png"},6627:(e,n,i)=>{i.d(n,{A:()=>t});const t=i.p+"assets/images/login_demo_3-b689a0f3f424b94144832e299a5d3026.png"},8453:(e,n,i)=>{i.d(n,{R:()=>o,x:()=>d});var t=i(6540);const r={},s=t.createContext(r);function o(e){const n=t.useContext(s);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),t.createElement(s.Provider,{value:n},e.children)}}}]);